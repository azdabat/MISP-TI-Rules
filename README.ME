<h1 align="center">ğŸ§  MISP-Enriched Threat Hunting â€” Supply-Chain & OAuth Abuse</h1>
<p align="center">
  <b>Advanced Detection Suite (2025-11)</b><br>
  <i>By Ala Dabat Â· Senior Cyber Threat Intelligence Analyst</i>
</p>

---

<h2>ğŸ¯ Objective</h2>
<p>
Detect and triage <b>supply-chain, credential, and identity abuse</b> attacks using Microsoft Sentinel / MDE rules enriched with <b>MISP</b> & <b>OpenCTI</b> intelligence.  
Each KQL query includes MITRE ATT&amp;CK mapping, adaptive scoring, and inline <b>Hunter Directives</b>.
</p>

---

<h2>âš™ï¸ Scoring Model</h2>

```
FinalScore = (DetectionSignal Ã— 0.4) + (IntelConfidence Ã— 0.3) + (KillChain Ã— 0.2) + (Temporal Ã— 0.1)
```

<table>
<tr><th>Mode</th><th>Data Sources</th><th>Enrichment</th><th>MITRE Focus</th><th>Value</th></tr>
<tr><td><b>Native</b></td><td>Device*, SecurityEvent</td><td>None</td><td>Persistence / Exec</td><td>Baseline / Low Resource</td></tr>
<tr><td><b>MISP Integrated</b></td><td>+ ThreatIntelligenceIndicator</td><td>TLP, Confidence, Tags</td><td>Contextual Correlation</td><td>High Fidelity</td></tr>
<tr><td><b>Adaptive</b></td><td>Cross-table</td><td>Rarity + Recency</td><td>Persistence â†’ C2</td><td>Analyst Triage-Ready</td></tr>
</table>

---

<h2>ğŸ“ Rule Suite</h2>

<ul>
<li><code>01_DLL_Sideloading_Adaptive.kql</code> â€” Signed binary drift &amp; delayed load</li>
<li><code>02_Registry_Persistence_MISP_Enriched.kql</code> â€” Autorun / IFEO persistence</li>
<li><code>03_Suspicious_Ports_with_External_CSV.kql</code> â€” Outbound C2 channels</li>
<li><code>04_SMB_Lateral_NotPetya_Style.kql</code> â€” Worm-style propagation</li>
<li><code>05_OAuth_Consent_Abuse.kql</code> â€” Cloud identity persistence</li>
<li><code>06_Rogue_Endpoint_ZeroTrust.kql</code> â€” Unmanaged endpoint discovery</li>
<li><code>07_BEC_Clickthrough_Enriched.kql</code> â€” Malicious email click tracking</li>
</ul>

---

<h2>ğŸ“Š Updated Coverage Matrix (All Rules Applied)</h2>

<table>
<tr><th>Attack / Stage</th><th>Initial Compromise</th><th>DLL Load</th><th>Driver Drop</th><th>Registry / Service Persist</th><th>C2 / Exfil</th><th>Cred Access</th><th>Lateral Move</th><th>Notes</th></tr>

<tr><td><b>SolarWinds (SUNBURST)</b></td><td>â¬œ</td><td>ğŸŸ©</td><td>ğŸŸ¨</td><td>ğŸŸ©</td><td>ğŸŸ©</td><td>ğŸŸ¨</td><td>ğŸŸ¨</td><td>Sideload + registry keys + C2; encrypted TLS blend.</td></tr>
<tr><td><b>NotPetya (M.E.Doc)</b></td><td>â¬œ</td><td>ğŸŸ¨</td><td>ğŸŸ©</td><td>ğŸŸ©</td><td>ğŸŸ¨</td><td>ğŸŸ©</td><td>ğŸŸ©</td><td>PsExec/WMI spread + ADMIN$ service creation.</td></tr>
<tr><td><b>3CX Supply-Chain</b></td><td>â¬œ</td><td>ğŸŸ©</td><td>ğŸŸ¨</td><td>ğŸŸ©</td><td>ğŸŸ©</td><td>ğŸŸ¨</td><td>ğŸŸ¨</td><td>Signed process loads rare DLL; TI C2 match.</td></tr>
<tr><td><b>F5 2025</b></td><td>â¬œ</td><td>ğŸŸ¨</td><td>ğŸŸ¨</td><td>ğŸŸ©</td><td>ğŸŸ©</td><td>ğŸŸ©</td><td>ğŸŸ¨</td><td>Cloud/dev pivot; OAuth and registry signals.</td></tr>
<tr><td><b>NTT DATA 2025</b></td><td>â¬œ</td><td>ğŸŸ©</td><td>ğŸŸ¨</td><td>ğŸŸ©</td><td>ğŸŸ¨</td><td>ğŸŸ¨</td><td>ğŸŸ¨</td><td>Dormant implant; temporal + TI scores help.</td></tr>
</table>

<p><b>MISP integration</b> adds context (TLP, Confidence, Tags) that turns â€œrare DLLâ€ or â€œodd portâ€ anomalies into high-confidence alerts by confirming known C2, hashes, or actors.</p>

---

<h2>ğŸ“ˆ Detection Strength by Attack (Full Stack + MISP Adaptive)</h2>

<table>
<tr><th>Attack</th><th>Coverage</th><th>Strongest Rules</th><th>Gaps / Limitations</th></tr>
<tr><td><b>SolarWinds</b></td><td>ğŸŸ©ğŸŸ©ğŸŸ©â¬œ (80%)</td><td>DLL Sideload Â· Registry Â· SMB Â· TI</td><td>Encrypted C2 in legit traffic.</td></tr>
<tr><td><b>NotPetya</b></td><td>ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© (85%)</td><td>SMB Lateral Â· LSASS Â· Registry Â· Kerberos</td><td>Trojanized update pre-compromise.</td></tr>
<tr><td><b>3CX</b></td><td>ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ©ğŸŸ© (95%)</td><td>DLL Â· Registry Â· Ports Â· SMB</td><td>Memory-only payload gap.</td></tr>
<tr><td><b>F5 2025</b></td><td>ğŸŸ©ğŸŸ©ğŸŸ¨â¬œ (75%)</td><td>Rogue Endpoint Â· Registry Â· OAuth</td><td>Cloud noise masking.</td></tr>
<tr><td><b>NTT DATA 2025</b></td><td>ğŸŸ©ğŸŸ¨â¬œâ¬œ (65%)</td><td>Registry Â· DLL Sideload Â· TI</td><td>Delayed activation.</td></tr>
</table>

---

<h2>ğŸ§¬ Attack Chain Diagrams</h2>

<h3>SolarWinds / SUNBURST</h3>

<pre>
[Build Compromise] â†’ [Signed Trojan DLL] â†’ [Beacon avsvmcloud.com]
   â†’ [Stage-2 Download] â†’ [Lateral Movement] â†’ [Registry Persistence]
</pre>

<h3>3CX</h3>

<pre>
[Installer Trojan] â†’ [DLL Sideload (d3dcompiler_47.dll)] â†’ [Driver Drop .sys]
   â†’ [Rundll32 C2 Beacon] â†’ [Registry Persist] â†’ [Exfiltration]
</pre>

<h3>NotPetya</h3>

<pre>
[M.E.Doc Update] â†’ [Trojan Exec] â†’ [PsExec/WMI Spread]
   â†’ [Credential Dump (LSASS)] â†’ [MBR Wipe]
</pre>

<h3>F5 / NTT</h3>

<pre>
[Vendor Access] â†’ [LDAP Exfil] â†’ [Internal Pivot]
   â†’ [Driver Abuse] â†’ [Client Data Leak]
</pre>

---

<h2>ğŸ§® Rule Effectiveness (Example Scores)</h2>

<table>
<tr><th>Rule</th><th>Detection</th><th>Intel</th><th>KillChain</th><th>Temporal</th><th>Final</th><th>Risk</th></tr>
<tr><td>DLL Sideload</td><td>0.85</td><td>0.75</td><td>0.80</td><td>0.90</td><td>86</td><td>HIGH</td></tr>
<tr><td>Registry Persistence</td><td>0.80</td><td>0.70</td><td>0.70</td><td>0.85</td><td>78</td><td>MED</td></tr>
<tr><td>SMB Lateral</td><td>0.90</td><td>0.80</td><td>0.90</td><td>1.00</td><td>91</td><td>CRITICAL</td></tr>
<tr><td>OAuth Consent</td><td>0.95</td><td>0.90</td><td>0.85</td><td>0.95</td><td>92</td><td>CRITICAL</td></tr>
</table>

---

<h2>ğŸ§© MITRE ATT&amp;CK Mapping</h2>

<table>
<tr><th>Attack</th><th>Tactics</th><th>Techniques</th></tr>
<tr><td>SolarWinds</td><td>TA0007 Exec Â· TA0003 Persist Â· TA0011 C2</td><td>T1574.002 DLL Hijack Â· T1059.001 PowerShell Â· T1547.001 Run Keys</td></tr>
<tr><td>NotPetya</td><td>TA0007 Exec Â· TA0003 Persist Â· TA0008 Lateral</td><td>T1021.002 SMB Â· T1003 Cred Dump Â· T1569.002 Service Exec</td></tr>
<tr><td>3CX</td><td>TA0007 Exec Â· TA0001 Initial Access Â· TA0011 C2</td><td>T1574 Sideload Â· T1105 Ingress Transfer</td></tr>
<tr><td>F5 / NTT</td><td>TA0003 Persist Â· TA0005 Defense Evasion Â· TA0011 C2</td><td>T1553 Code Signing Abuse Â· T1021 Network Services</td></tr>
</table>

---

<h2>ğŸ”— MISP / OpenCTI Integration</h2>

<table>
<tr><th>Feed</th><th>Connector</th><th>Fields</th><th>Tags</th></tr>
<tr><td>TAXII 2.1 â†’ Sentinel ThreatIntelligenceIndicator</td><td>ConfidenceScore, TLP, Tags</td><td><code>supply-chain:solarwinds</code>, <code>campaign:ntt2025</code>, <code>technique:dll-sideloading</code></td></tr>
</table>

<p>Feedback Loop â†’ Analyst Sightings â†’ MISP â†’ OpenCTI â†’ Updated Confidence.</p>

---

<h2>ğŸ§° NIST Incident Response Lifecycle</h2>

<table>
<tr><th>Phase</th><th>Rules</th><th>Objective</th></tr>
<tr><td>Detect</td><td>Registry Â· DLL Â· OAuth</td><td>Identify persistence</td></tr>
<tr><td>Analyze</td><td>SMB Â· Rogue Endpoint</td><td>Trace lateral routes</td></tr>
<tr><td>Contain</td><td>DLL + Registry</td><td>Isolate spread</td></tr>
<tr><td>Eradicate</td><td>SMB + Driver</td><td>Remove services</td></tr>
<tr><td>Recover</td><td>TI Feeds</td><td>Confirm IOC clear</td></tr>
<tr><td>Lessons Learned</td><td>All</td><td>Feed back to MISP/OpenCTI</td></tr>
</table>

---

<h2>ğŸ§  Key Takeaways</h2>

<ul>
<li>âœ… MISP context elevates low-confidence detections â†’ high-fidelity alerts.</li>
<li>âœ… DLL Sideload rule closes signed-binary blind spots.</li>
<li>âœ… Adaptive scoring links Installer â†’ DLL â†’ Registry â†’ C2 â†’ Lateral.</li>
<li>â¡ï¸ Overall coverage: <b>â‰ˆ 88 % with MISP</b> vs 55 % native only.</li>
</ul>

---

<h2>ğŸ“˜ Usage</h2>

<ol>
<li>Import <code>.kql</code> files into Sentinel â†’ <b>Hunting</b>.</li>
<li>Schedule alerts where <code>FinalScore â‰¥ 90</code>.</li>
<li>Enable MISP TAXII ThreatIntel Connector.</li>
<li>Feed Sightings â†’ MISP/OpenCTI.</li>
<li>Map alerts â†’ NIST IR Lifecycle.</li>
</ol>

---

<h2 align="center">ğŸ‘¤ Author / Contact</h2>
<p align="center">
<b>Ala Dabat</b> â€” Senior Cyber Threat Intelligence Analyst<br>
<i>Focused on supply-chain compromise modeling, adaptive KQL detection, and MISP/OpenCTI fusion.</i><br>
<a href="https://github.com/azdabat">GitHub: azdabat</a>
</p>
