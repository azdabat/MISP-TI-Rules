# ğŸ§© Supply-Chain Compromise / Signed Binary Drift & DLL-Driver Abuse Detection
**Author:** Ala Dabat  
**Platform:** Microsoft Defender / Sentinel (Advanced Hunting â€“ Native KQL)  
**Classification:** L3 Threat Hunt / Analytic Rule  
**Version:** 2.1 (Enhanced for Integrity Drift)  
**Last Updated:** 2025-11-11  

---

## ğŸ” Overview
This rule detects **supply-chain compromises** and **signed binary abuse** on endpoints by correlating:
- Signed but **tampered vendor binaries** (version/signature drift)
- **DLL sideloading** and **driver injection** abuse
- **Registry persistence** (ServiceDll, InprocServer32, Run keys)
- **Dormant or delayed activation** typical of SolarWinds/3CX-style implants  
- **Network, process, and driver context** for kill-chain correlation  

It introduces **integrity-drift analytics** to identify binaries whose signature, hash, or version differs from the organizationâ€™s baseline, signaling a potential **compromised update or malicious rebuild**.

---

## âš™ï¸ Detection Logic Summary

Signed Orion process
â†“ loads
Trojanized BusinessLayerHost.dll
â†“ dormant 14 days
â†“ registry persist (ServiceDll)
â†“ driver drop / C2 beacon

âœ… Detected through **DormantVeryLong + SignerDrift + Registry persistence**

---

### 2ï¸âƒ£ 3CX Compromise


3cxdesktopapp.exe (signed)
â†“ loads
d3dcompiler_47.dll (malicious)
â†“ fast-load & network C2

âœ… Detected via **VendorProcess + FastLoad + Unsigned DLL**

---

### 3ï¸âƒ£ F5 BIG-IP Breach


Vendor service binary (signed)
â†“ loads
Injected DLL â†’ drops signed driver
â†“ reactivated after reboot

âœ… Detected via **DriverLoad + DormantLong + Registry persistence**

---

## ğŸ§­ SOC Hunter Directives
Each alert includes structured guidance in the `HunterDirectives` column:

1. Review loader process & signer integrity  
2. Verify **version / signer / hash drift** vs baseline  
3. Analyze **Createâ†’Load delay** (fast vs dormant)  
4. Check registry persistence near event time  
5. Confirm driver activity or kernel module loads  
6. Investigate related **network connections**  
7. If **ALERT:** isolate host, dump memory, preserve binaries  
8. If **HUNT:** pivot across devices and verify vendor authenticity  

---

## ğŸ§© False-Positive Guidance
| Source | Mitigation |
|---------|-------------|
| Legitimate vendor update | Validate signer + version in vendor release notes |
| Internal software builds | Add internal publisher to `TrustedPublishers` |
| EDR/AV agent self-updates | Verify signer + allowlist path temporarily |

---

## ğŸ§© Deployment Notes
- Designed for **native use** in Microsoft Defender / Sentinel Advanced Hunting.  
- No external TI feeds required.  
- Can be promoted to **Analytic Rule** with alert automation using `Severity=="ALERT"`.  
- For enrichment, integrate with **MISP/OpenCTI** to cross-check drifted binaries with known IoCs.

---

## ğŸ§© Expected Results
| Attack Vector | Detection | Confidence |
|----------------|------------|-------------|
| Vendor binary tampering | âœ… | ğŸ”¥ High |
| Dormant or staged loader | âœ… | High |
| BYOVD driver implant | âœ… | High |
| Registry-only persistence | âœ… | Medium-High |
| File-less reflective load | âš™ Partial | Medium |

---

## ğŸ§© Recommendations
- Add **continuous baseline jobs** for version/signer tracking every 7 days.  
- Integrate **hash drift** with your asset inventory or CMDB for supply-chain integrity monitoring.  
- Maintain an **allowlist file** for legitimate vendor updates (auto-expire after 30 days).  
- Periodically refresh **TrustedPublishers** and **VendorProcesses** lists.

---

## ğŸ“„ License & Attribution
Â© 2025 Ala Dabat â€“ MIT License.  
Free to use, modify, and redistribute with attribution.  
If reused, reference this repo as:  
`https://github.com/azdabat/MISP-TI-Rules`  

---

### ğŸ§± Tags
`#KQL` `#DetectionEngineering` `#SupplyChain` `#DLLHijacking`  
`#DriverAbuse` `#MITREATTACK` `#ThreatHunting` `#IntegrityMonitoring`

| Component | Purpose |
|------------|----------|
| `DeviceFileEvents` | Tracks DLL/EXE/driver creation and version/signature drift |
| `DeviceImageLoadEvents` | Identifies execution or load of suspicious DLLs |
| `DeviceRegistryEvents` | Flags registry-based persistence mechanisms |
| `DeviceEvents` | Detects driver loads (including file-less BYOVD) |
| `DeviceNetworkEvents` | Adds C2 or callback context |
| `OrgPrevalence` | Baselines file rarity across the tenant |
| `IntegrityDrift` | Detects signer/version/hash drift of signed apps |

---

## ğŸ§  Detection Methodology

The rule computes:
- **BehaviorScore** â†’ Execution timing, rarity, unsigned state, vendor loader
- **KillChainScore** â†’ Driver / registry persistence correlation
- **RecencyScore** â†’ Prioritizes new activity  
- **FinalScore = 0.6Ã—Behavior + 0.3Ã—KillChain + 0.1Ã—Recency**

Then classifies as:
| Severity | Threshold | Action |
|-----------|------------|--------|
| **ALERT** | â‰¥ 75 | Trigger incident, isolate host |
| **HUNT** | 40â€“74 | Investigate, pivot across estate |
| **LOG** | < 40 | Baseline / telemetry only |

---

## ğŸ§© MITRE ATT&CK Mapping
| Tactic | Technique ID | Description |
|--------|---------------|-------------|
| **Persistence** | `T1547.*` | Registry & service DLL persistence |
| **Defense Evasion** | `T1574.002` | DLL Search Order Hijacking |
| **Privilege Escalation** | `T1547.006` | Driver-based persistence |
| **Execution** | `T1055` | Indirect code load (via DLL/driver) |
| **Command & Control** | `T1071`, `T1105` | Network beaconing / data transfer |
| **Defense Evasion** | `T1553.002` | Code-signing certificate abuse |

---

## ğŸ§© Detection Capabilities by Attack Type

| Attack Type | Example | Coverage |
|--------------|----------|-----------|
| DLL sideloading | SolarWinds, 3CX | âœ… Full |
| Signed driver abuse | F5, BlackByte | âœ… Full |
| Dormant loaders | SUNBURST, CCleaner | âœ… Full |
| Registry persistors | Run / ServiceDll keys | âœ… Full |
| Version/signature drift | Vendor app tampering | âœ… Full |
| File-less in-memory load | Reflective injection | âš™ Partial |
| Pure cloud/SaaS compromise | Okta / CircleCI | âŒ Out of scope |

---

## ğŸ§© Example Attack Chains Detected

### 1ï¸âƒ£ SolarWinds / SUNBURST Pattern


---

## ğŸ” End-to-End Flow Summary

1. **File Drop / Modification:** Suspicious DLL or SYS created on host.  
2. **Execution:** File loaded by signed vendor process (e.g., 3CX.exe).  
3. **Persistence:** Registry or service entry modified to ensure reboot survival.  
4. **Integrity Drift:** Binaryâ€™s signer or version deviates from baseline.  
5. **Kill-Chain Correlation:** Network, process, and driver telemetry unified.  
6. **Scoring Engine:** Behavior + Kill-Chain + Recency â†’ FinalScore.  
7. **Analyst Output:** HunterDirectives guide triage, isolation, and validation.

---

### ğŸ“Š Visualization Summary
- **Blue boxes (Process/File telemetry)** â†’ `DeviceFileEvents`, `DeviceImageLoadEvents`
- **Orange boxes (Persistence / Drift)** â†’ `DeviceRegistryEvents`, `IntegrityDrift`
- **Green boxes (Execution / Network)** â†’ `DeviceEvents`, `DeviceNetworkEvents`
- **Red box (FinalScore)** â†’ Unified analytic scoring (Alert/Hunt/Log)

---


