// ===================================================================
// L3 Native Hunt: Comprehensive DLL Sideloading + Driver + Registry Persistence
// - Detects fast drop->load, delayed/dormant loads, .sys drops near-load,
//   DLL-focused registry persistence changes (ServiceDll / InprocServer32 / AppInit / Run keys),
// - Org-prevalence (rarity) for reducing noise,
// - Scoring, severity, MITRE mapping, threat-hunter directives.
// - No TI/Sentinel integration; native-only.
// Author: Ala Dabat (adapted for MDE advanced hunting)
// ===================================================================

// -------------------- Tunables --------------------
let lookback = 14d;                // surveillance window for events
let prevalenceWindow = 90d;        // window to compute org-prevalence (rarity)
let fastLoadSec = 300;             // <= 5 minutes considered FAST load
let dormantShortSec = 86400;       // 5min-24h considered short dormancy
let dormantLongSec = 604800;       // 1-7 days long dormancy
let dormantVeryLongSec = 2592000;  // >7 - 30 days (very long)
let scoreAlertThreshold = 70;      // FinalScore >= ALERT
let scoreHuntThreshold  = 40;      // FinalScore >= HUNT

// Optional scope: uncomment to limit to a single host for testing
// let targetHost = "FIN-LAP-024";

// Trusted/known lists (tune per org or replace with watchlists)
let TrustedPublishers = dynamic(["Microsoft Corporation","Microsoft Windows","Google LLC","Mozilla Corporation"]);
let CommonLoaders = dynamic(["explorer.exe","svchost.exe","mmc.exe","msiexec.exe","servicehost.exe","services.exe"]);
let VendorProcesses = dynamic(["3cx.exe","SolarWinds.BusinessLayerHost.exe","vendor.exe"]); // expand as needed

// -------------------- Prevalence table (rarity) --------------------
let OrgPrevalence =
DeviceFileEvents
| where Timestamp >= ago(prevalenceWindow)
| summarize SeenDeviceCount = dcount(DeviceId) by SHA256, FileName, FolderPath;

// -------------------- Image loads (DLL) --------------------
let ImageLoads =
DeviceImageLoadEvents
| where Timestamp >= ago(lookback)
| where ImageFileName endswith ".dll"
| project ImageLoadTime = Timestamp,
          DeviceId, DeviceName,
          LoaderProc = ProcessFileName,
          LoaderPID = ProcessId,
          ImageFileName,
          ImageSHA256 = coalesce(SHA256, tostring(ImageHash)),
          SignatureStatus, Signer;

// -------------------- File creates (DLL) --------------------
let FileCreates =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where FileName endswith ".dll"
| project FileCreateTime = Timestamp,
          DeviceId, DeviceName,
          FileName, FolderPath,
          FileSHA256 = SHA256,
          InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessSigner;

// -------------------- Driver (.sys) drops --------------------
let SysDrops =
DeviceFileEvents
| where Timestamp >= ago(lookback)
| where FileName endswith ".sys" or FolderPath has_any (dynamic(["\\drivers\\","\\system32\\drivers\\"]))
| project DriverTime = Timestamp,
          DeviceId, DeviceName,
          SysFile = FileName, SysFolder = FolderPath, SysSHA256 = SHA256,
          SysInitiator = InitiatingProcessFileName, SysCmd = InitiatingProcessCommandLine, SysSigner = InitiatingProcessSigner;

// -------------------- Registry persistence (DLL-focused keys / values) --------------------
let PersistenceKeys = dynamic([
  // ServiceDll - changes to a service's ServiceDll (kernel/usermode driver DLL entry)
  @"HKLM\SYSTEM\CurrentControlSet\Services\*\Parameters\ServiceDll",
  // AppInit & AppInit flags (global DLL injection)
  @"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs",
  @"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows\LoadAppInit_DLLs",
  // COM InprocServer32
  @"HKCU\Software\Classes\CLSID\*\InprocServer32",
  @"HKLM\Software\Classes\CLSID\*\InprocServer32",
  // IFEO Debugger / SilentProcessExit monitor (often abused)
  @"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\*\Debugger",
  @"HKLM\Software\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\*\MonitorProcess",
  // LSA / SSP injection (auth provider DLLs)
  @"HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Authentication Packages",
  @"HKLM\SYSTEM\CurrentControlSet\Control\Lsa\Security Packages",
  // Known Run keys (may reference DLLs or rundll calls)
  @"HKLM\Software\Microsoft\Windows\CurrentVersion\Run",
  @"HKCU\Software\Microsoft\Windows\CurrentVersion\Run",
  @"HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce",
  @"HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce",
  // IFEO / Image File Execution Options generic
  @"HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\*",
  // SafeDllSearchMode (weakening search order is notable)
  @"HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\SafeDllSearchMode",
  // KnownDLLs (rarely writable but interesting)
  @"HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs"
]);

let RegWrites =
DeviceRegistryEvents
| where Timestamp >= ago(lookback)
| where ActionType == "RegistryValueSet"
| where RegistryKey has_any (PersistenceKeys)
| project RegTime = Timestamp,
          DeviceId, DeviceName,
          RegistryKey, RegistryValueName, RegistryValueData;

// -------------------- Minimal network/process context --------------------
let NetCtx =
DeviceNetworkEvents
| where Timestamp >= ago(lookback)
| project NetTime = Timestamp, DeviceId, DeviceName, RemoteIP, RemotePort, RemoteUrl, InitiatingProcessFileName, InitiatingProcessCommandLine;

let ProcCtx =
DeviceProcessEvents
| where Timestamp >= ago(lookback)
| project ProcTime = Timestamp, DeviceId, DeviceName, ProcessFileName = FileName, ProcessCommandLine = ProcessCommandLine, ParentProcess = InitiatingProcessFileName, ProcSHA256 = InitiatingProcessSHA256, ProcSigner = InitiatingProcessSigner;

// -------------------- Construct candidate events: join image loads -> creates (to compute create->load delay) --------------------
let Candidates =
ImageLoads
| join kind=leftouter (OrgPrevalence) on $left.ImageSHA256 == $right.SHA256
| join kind=leftouter (FileCreates) on $left.DeviceId == $right.DeviceId and $left.ImageSHA256 == $right.FileSHA256
| extend Seconds_CreateToLoad = iff(isnotempty(FileCreateTime), tolong(datetime_diff('second', ImageLoadTime, FileCreateTime)), long(999999))
| extend
    IsUnsigned          = iif(SignatureStatus !in ("Signed","Valid") or isempty(Signers) or isnull(Signer) or Signer == "", 1, 0),
    TrustedSigner       = iif(SignatureStatus in ("Signed","Valid") and Signer in~ (TrustedPublishers), 1, 0),
    IsRare              = iif(coalesce(SeenDeviceCount,0) <= 2, 1, 0),
    LoaderIsVendor      = iif(LoaderProc in~ (VendorProcesses), 1, 0),
    LoaderIsCommon      = iif(LoaderProc in~ (CommonLoaders), 1, 0),
    FastLoad            = iif(abs(Seconds_CreateToLoad) <= fastLoadSec, 1, 0),
    DormantShort        = iif(Seconds_CreateToLoad > fastLoadSec and Seconds_CreateToLoad <= dormantShortSec, 1, 0),
    DormantLong         = iif(Seconds_CreateToLoad > dormantShortSec and Seconds_CreateToLoad <= dormantLongSec, 1, 0),
    DormantVeryLong     = iif(Seconds_CreateToLoad > dormantLongSec and Seconds_CreateToLoad <= dormantVeryLongSec, 1, 0);

// -------------------- Correlate with driver drops, registry writes, process & network events within Â±2h --------------------
let Correlated =
Candidates
| join kind=leftouter (SysDrops) on DeviceId
| where isnull(DriverTime) or (DriverTime between (ImageLoadTime .. ImageLoadTime + 2h))
| join kind=leftouter (RegWrites) on DeviceId
| where isnull(RegTime) or (RegTime between (ImageLoadTime .. ImageLoadTime + 2h))
| join kind=leftouter (ProcCtx) on $left.DeviceId == $right.DeviceId
| where isnull(ProcTime) or (ProcTime between (ImageLoadTime - 2h .. ImageLoadTime + 2h))
| join kind=leftouter (NetCtx) on $left.DeviceId == $right.DeviceId
| where isnull(NetTime) or (NetTime between (ImageLoadTime - 2h .. ImageLoadTime + 2h))
| extend
    // registry-value heuristics
    RegValLower = tolower(tostring(RegistryValueData)),
    MentionsDLL  = iif(RegValLower matches regex @"(?i)\.dll\b" or RegistryKey has @"\InprocServer32" or RegistryKey has @"\ServiceDll", 1, 0),
    CallsLoader  = iif(RegValLower has_any ("rundll32","regsvr32","regsvr32 /i", "regsvr32 /s"), 1, 0),
    UserWritablePath = iif(RegValLower has_any ("\\appdata\\","\\programdata\\","\\users\\","\\temp\\"), 1, 0),
    SafeDllSearchWeak = iif(RegistryKey endswith @"\Session Manager\SafeDllSearchMode" and toint(RegistryValueData) == 0, 1, 0);

// -------------------- Scoring: behavior + kill-chain + recency --------------------
Correlated
| extend
    BehaviorScore =
        // fast/dormant weighting (fast often = immediate drop-&-load; delayed indicates dormancy/supply chain)
        (3 * toint(FastLoad)) +
        (1 * toint(DormantShort)) +
        (2 * toint(DormantLong)) +
        (3 * toint(DormantVeryLong)) +
        // signature / rarity / loader context
        (3 * toint(IsUnsigned)) +
        (2 * toint(IsRare)) +
        (2 * toint(LoaderIsVendor)) -
        (1 * toint(TrustedSigner)) -
        (1 * toint(LoaderIsCommon)),
    KillChainScore =
        toint(isnotempty(SysFile)) +          // driver activity
        toint(MentionsDLL) +                  // registry mentions DLL or InprocServer32 / ServiceDll
        toint(CallsLoader) +                  // registry calls to loaders
        toint(UserWritablePath),              // persistence pointing to user-writable path
    RecencyScore = iif(ImageLoadTime >= ago(24h), 10, 0),
    // Final weighted score (tunable weights)
    FinalScore = round( (BehaviorScore * 0.6) + (KillChainScore * 0.3) + (RecencyScore * 0.1), 1 ),
    Severity = case(
        FinalScore >= scoreAlertThreshold, "ALERT",
        FinalScore >= scoreHuntThreshold, "HUNT",
        "LOG"
    )
| extend
    MITRE_Tactics = "TA0003 Persistence; TA0005 Defense Evasion; TA0011 Command & Control",
    MITRE_Techniques = strcat_array(pack_array(
        "T1574.002 DLL Search Order Hijacking",
        iif(MentionsDLL==1, "T1547.* Registry-based Persistence",""),
        iif(isnotempty(SysFile), "T1547.006 Kernel/Driver Persistence",""),
        iif(isnotempty(RemoteIP) or isnotempty(RemoteUrl), "T1071 App-Layer Protocol; T1105 Ingress Tool Transfer","")
    ), "; "),
    HunterDirectives = pack_array(
        strcat("1) Review loader process: ", LoaderProc, " (PID ", tostring(LoaderPID), ") ; signer=", tostring(Signer)),
        strcat("2) Check create->load timing: ", tostring(Seconds_CreateToLoad), "s (fast=", tostring(FastLoad), ", dormantLong=", tostring(DormantLong), ", dormantVeryLong=", tostring(DormantVeryLong), ")"),
        strcat("3) Registry persistence near-time? ", iif(MentionsDLL==1, strcat("YES: ", RegistryKey, " => ", RegistryValueData), "NO")),
        strcat("4) Driver dropped near-time? ", iif(isnotempty(SysFile), strcat("YES: ", SysFile, " by ", SysInitiator), "NO")),
        strcat("5) Network seen near-time? ", iif(isnotempty(RemoteUrl) or isnotempty(RemoteIP), coalesce(RemoteUrl, RemoteIP), "NO")),
        "6) Triage: if Severity=ALERT => isolate host, collect memory, pull full process tree, export files",
        "7) Triage: if Severity=HUNT  => pivot by ImageSHA256 & file path across estate, check peer prevalence",
        "8) If FP: document signer/path allowlist with expiry; keep audit trail"
    )
// Final projection for analyst consumption
| project Severity, FinalScore,
          ImageLoadTime, DeviceName, LoaderProc, LoaderPID,
          ImageFileName, ImageSHA256, SignatureStatus, Signer, SeenDeviceCount,
          Seconds_CreateToLoad, FastLoad, DormantShort, DormantLong, DormantVeryLong,
          // Registry & driver evidence
          RegTime, RegistryKey, RegistryValueName, RegistryValueData, MentionsDLL, CallsLoader, UserWritablePath, SafeDllSearchWeak,
          DriverTime, SysFile, SysFolder, SysInitiator, SysCmd,
          // Network & proc context
          NetTime, RemoteIP, RemotePort, RemoteUrl, ProcessFileName, ProcessCommandLine,
          MITRE_Tactics, MITRE_Techniques, HunterDirectives
| order by Severity desc, FinalScore desc, ImageLoadTime desc;
