// ======================================================
//  L3_HUNT_BYOVD_2025_Advanced
//  MITRE: TA0004, TA0005, TA0003 | T1068, T1547.012, T1562.001
//  Author: Ala Dabat | Version: 2025-11
// ======================================================

let timeframe = 14d;
let MISP_Lookback = 30d;

// ---------------- MISP THREAT INTELLIGENCE INTEGRATION ----------------
let MISP_Driver_IOCs = externaldata(
    value:string, type:string, category:string, tags:string,
    first_seen:datetime, last_seen:datetime, confidence:int, orgc:string
)
[
  "https://misp.instance.com/events/restsearch/download/format:csv/tags:byovd||driver_malicious||driver_vulnerable"
]
with (format="csv", ignoreFirstRecord=true, ignoreEmpty=true)
| where confidence >= 70
| where type in ("sha256","filename","windows-service-name","impashash")
| extend MISP_Confidence = confidence,
         MISP_Org = orgc,
         MISP_FirstSeen = first_seen;

// ---------------- DRIVER LOAD / UNLOAD EVENTS ----------------
let DriverLoadEvents = materialize(
    DeviceEvents
    | where Timestamp > ago(timeframe)
    | where ActionType in ("DriverLoaded","DriverLoad")
    | extend DriverName = tostring(FileName),
             DriverPath = tostring(FolderPath),
             DriverSHA256 = tostring(SHA256),
             LoadTime = Timestamp,
             InitiatingProcessSHA256 = tostring(ExtendedProperties.InitiatingProcessSHA256)
    | project LoadTime, DeviceId, DeviceName, DriverName, DriverPath, DriverSHA256,
              InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessSHA256
);

let DriverUnloadEvents = materialize(
    DeviceEvents
    | where Timestamp > ago(timeframe)
    | where ActionType in ("DriverUnloaded","DriverUnload")
    | extend DriverName = tostring(FileName),
             UnloadTime = Timestamp,
             DriverSHA256 = tostring(SHA256)
    | project UnloadTime, DeviceId, DriverName, DriverSHA256
);

// ---------------- DORMANT DRIVERS ----------------
let DormantDrivers =
    DriverLoadEvents
    | join kind=leftanti (DriverUnloadEvents) on DeviceId, DriverSHA256
    | where LoadTime < ago(24h)
    | extend DormantHours = datetime_diff("hour", LoadTime, now())
    | where DormantHours >= 24;

// ---------------- INSTANT LOAD/UNLOAD (EPHEMERAL) ----------------
let InstantLoadPatterns =
    DriverLoadEvents
    | join kind=inner (DriverUnloadEvents) on DeviceId, DriverSHA256
    | where UnloadTime - LoadTime between (0ms .. 300000ms)
    | extend LoadDurationSeconds = datetime_diff("second", LoadTime, UnloadTime)
    | where LoadDurationSeconds between (1 .. 300)
    | extend InstantLoadPattern = strcat("Instant_Load_", bin(LoadDurationSeconds,30),"s");

// ---------------- ANOMALOUS LOADERS ----------------
let SuspiciousParentProcesses = dynamic([
  "powershell.exe","cmd.exe","mshta.exe","rundll32.exe",
  "wscript.exe","cscript.exe","msbuild.exe","installutil.exe"
]);

let AnomalousLoaderPatterns =
    DriverLoadEvents
    | where InitiatingProcessFileName in~ (SuspiciousParentProcesses)
    | where InitiatingProcessCommandLine has_any (
        "-ep bypass","bypass","hidden","encoded","IEX","Invoke-","FromBase64"
    );

// ---------------- SUSPICIOUS IOCTL OPERATIONS ----------------
let SuspiciousIOCTLEvents =
    DeviceEvents
    | where Timestamp > ago(timeframe)
    | where ActionType == "IoControlCode"
    | extend DriverName = tostring(ExtendedProperties.DriverName),
             IOCTL_Code = tostring(ExtendedProperties.ControlCode),
             Operation = tostring(ExtendedProperties.Operation)
    | where IOCTL_Code has_any ("0x222000","0x220008","0x22000C","0x80002000","0x80002010","0x80002018")
    | where Operation in ("MemoryRead","MemoryWrite","ProcessAccess","DriverUnload")
    | summarize IOCTL_Count=count(), First_IOCTL=min(Timestamp), Last_IOCTL=max(Timestamp),
                Operations=make_set(Operation)
      by DeviceId,DeviceName,DriverName,IOCTL_Code;

// ---------------- SIGNATURE / CERTIFICATE VALIDATION ----------------
let UntrustedPublisherDrivers =
    DriverLoadEvents
    | where not(isempty(DriverSHA256))
    | extend SignatureStatus = case(
        DriverName has "Windows" and DriverPath contains "System32","Microsoft_Signed",
        DriverPath contains "Temp" or DriverPath contains "AppData","Unsigned_Temp",
        "ThirdParty_Signed"
    )
    | where SignatureStatus in ("Unsigned_Temp","ThirdParty_Signed")
    | join kind=inner (
        DeviceFileCertificateInfo
        | where Timestamp > ago(timeframe)
        | where CertificateSubject !has "Microsoft" and CertificateIssuer !has "Microsoft"
        | extend DriverSHA256=tostring(SHA256),
                 Publisher=tostring(CertificateSubject),
                 Issuer=tostring(CertificateIssuer)
    ) on DriverSHA256;

// ---------------- UNIFIED CORRELATION ENGINE ----------------
union
(DriverLoadEvents
 | join kind=inner (MISP_Driver_IOCs) on $left.DriverSHA256 == $right.value
 | extend DetectionSource="MISP_TI",
          ConfidenceScore=MISP_Confidence*1.2,
          TI_Org=MISP_Org, TI_FirstSeen=MISP_FirstSeen),

(DormantDrivers
 | extend DetectionSource="Dormant_Driver",
          ConfidenceScore=case(DormantHours>168,95,DormantHours>72,85,75),
          DormantDuration=strcat(DormantHours,"h")),

(InstantLoadPatterns
 | extend DetectionSource="Instant_Load_Unload",
          ConfidenceScore=case(LoadDurationSeconds<10,90,LoadDurationSeconds<60,85,80),
          LoadBehavior=InstantLoadPattern),

(AnomalousLoaderPatterns
 | extend DetectionSource="Suspicious_Loader", ConfidenceScore=85,
          LoaderAnomaly="Script_Based_Driver_Load"),

(SuspiciousIOCTLEvents
 | extend DetectionSource="Malicious_IOCTL",
          ConfidenceScore=case(IOCTL_Count>10,95,IOCTL_Count>5,90,85),
          IOCTL_Operations=array_strcat(Operations,", ")), 

(UntrustedPublisherDrivers
 | extend DetectionSource="Untrusted_Publisher",
          ConfidenceScore=case(SignatureStatus=="Unsigned_Temp",95,80),
          CertificateInfo=strcat("Publisher: ",Publisher," | Issuer: ",Issuer))

// ---------------- RISK SCORING & OUTPUT ----------------
| summarize
    TotalDetections=count(),
    DetectionSources=make_set(DetectionSource),
    MaxConfidence=max(ConfidenceScore),
    FirstSeen=min(LoadTime),
    LastSeen=max(LoadTime),
    DeviceCount=dcount(DeviceName),
    DriverNames=make_set(DriverName),
    SHA256Hashes=make_set(DriverSHA256),
    LoaderProcesses=make_set(InitiatingProcessFileName),
    BehavioralPatterns=make_set(LoaderAnomaly),
    IOCTLPatterns=make_set(IOCTL_Operations),
    CertificateData=make_set(CertificateInfo),
    MISPData=make_set(strcat(TI_Org,":",TI_FirstSeen))
    by DeviceId,DeviceName,bin(Timestamp,1h)
| extend RiskScore =
    MaxConfidence *
    iff(array_length(DetectionSources)>=2,1.3,1.0) *
    iff(DeviceCount>=3,1.2,1.0) *
    iff(DetectionSources has "Malicious_IOCTL",1.4,1.0) *
    iff(DetectionSources has "Dormant_Driver",1.3,1.0) *
    iff(DetectionSources has "Instant_Load_Unload",1.2,1.0)
| extend HunterDirective = case(
    RiskScore>=90," CRITICAL: Isolate and perform memory forensics ‚Äî multi-indicator BYOVD.",
    RiskScore>=80," HIGH: Capture driver memory, review IOCTL behavior.",
    RiskScore>=70," MEDIUM: Investigate driver provenance and persistence.",
    "üìù REVIEW: Monitor and validate driver legitimacy."
)
| extend MITRE_Tactic="Defense Evasion, Persistence, Privilege Escalation",
         MITRE_Technique="T1068, T1547.012, T1562.001",
         MITRE_Subtechnique="BYOVD, Boot/Logon Autostart, Disable/Modify Tools"
| project Timestamp,DeviceName,
          DriverCount=array_length(DriverNames),
          DetectionSources=array_strcat(DetectionSources,", "),
          RiskScore=round(RiskScore,2),MaxConfidence,TotalDetections,
          FirstSeen,LastSeen,
          BehavioralPatterns=array_strcat(BehavioralPatterns,", "),
          IOCTLPatterns=array_strcat(IOCTLPatterns,", "),
          MISP_Indicators=array_length(MISPData),
          HunterDirective,MITRE_Tactic,MITRE_Technique,MITRE_Subtechnique
| order by RiskScore desc, TotalDetections desc
